(()=>{let e=null,t=null,n=null,o=!1,l=Date.now(),i=null;function r(){if(document.getElementById("posture-guardian-control"))return;let e=document.createElement("div");e.id="posture-guardian-control",e.style.position="fixed",e.style.right="12px",e.style.bottom="12px",e.style.background="rgba(0,0,0,0.55)",e.style.color="white",e.style.padding="8px 10px",e.style.borderRadius="8px",e.style.zIndex=0x7ffffffe,e.style.fontFamily="sans-serif",e.style.fontSize="13px",e.style.boxShadow="0 6px 18px rgba(0,0,0,0.4)",e.innerHTML='<div style="display:flex;flex-direction:column;gap:6px;">Posture Guardian</div>',document.documentElement.appendChild(e)}function a(e,t){if(document.getElementById(e))return null;let n=document.createElement("div");return n.id=e,n.style.position="fixed",n.style.left="50%",n.style.top="20%",n.style.transform="translateX(-50%)",n.style.background="white",n.style.color="#111",n.style.padding="18px",n.style.borderRadius="10px",n.style.boxShadow="0 10px 40px rgba(0,0,0,0.4)",n.style.zIndex=0x7fffffff,n.innerHTML=t,n}function d(){let e=document.getElementById("posture-blur-overlay");e&&e.remove()}function s(){let e=document.getElementById("posture-eye-overlay");e&&e.remove()}async function u(){if(!o){try{e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}catch(e){console.warn("Webcam access required",e),alert("Webcam access is required for posture detection. Please allow camera access.");return}(t=document.createElement("video")).style.display="none",t.autoplay=!0,t.playsInline=!0,t.muted=!0,t.srcObject=e,document.body.appendChild(t),r(),o=!0,i=null,l=Date.now(),function e(){if(o){try{if(.02>Math.random()){i||(i=Date.now());let e=(Date.now()-i)/1e3;e>=3&&function(e="Please sit upright"){if(document.getElementById("posture-blur-overlay"))return;let t=a("posture-blur-overlay",`
    <h2 style="margin:0 0 8px 0;">Posture Alert</h2>
    <div style="margin-bottom:12px;">${e}</div>
    <div style="display:flex; gap:8px; justify-content:center;">
      <button id="pg-fix-btn" style="padding:8px 12px;">I fixed it</button>
      <button id="pg-snooze-btn" style="padding:8px 12px;">Snooze 5 min</button>
    </div>`);document.documentElement.appendChild(t),document.getElementById("pg-fix-btn").addEventListener("click",()=>{d(),i=null}),document.getElementById("pg-snooze-btn").addEventListener("click",()=>{d(),i=Date.now()+3e5})}(`You've been slouching for ${Math.round(e)}s. Sit upright.`)}else i=null,d();if(Date.now()-l>=72e4){c(),function(){if(document.getElementById("posture-eye-overlay"))return;let e=20,t=a("posture-eye-overlay",`
    <h2 style="margin:0 0 8px 0;">Eye Break \u{2014} 20-20-20</h2>
    <div id="pg-eye-text" style="font-size:18px; margin-bottom:12px;">Look at something far away for ${e} s</div>
    <div style="display:flex; gap:8px; justify-content:center;">
      <button id="pg-eye-done" style="padding:8px 12px;">Done</button>
    </div>`);document.documentElement.appendChild(t);let n=document.getElementById("pg-eye-text"),o=setInterval(()=>{e-=1,n&&(n.textContent=`Look at something far away for ${e} s`),e<=0&&(clearInterval(o),s(),l=Date.now())},1e3);document.getElementById("pg-eye-done").addEventListener("click",()=>{clearInterval(o),s(),l=Date.now()})}(),setTimeout(()=>{o||u()},1e3);return}}catch(e){console.error("Monitoring loop error",e)}n=requestAnimationFrame(e)}}()}}function c(){o=!1,n&&cancelAnimationFrame(n),n=null,t&&t.remove(),t=null,e&&(e.getTracks().forEach(e=>e.stop()),e=null),d(),s();let l=document.getElementById("posture-guardian-control");l&&l.remove()}chrome.runtime.onMessage.addListener((e,t,n)=>{e&&e.action&&("start-monitoring"===e.action&&u(),"stop-monitoring"===e.action&&c())}),r(),window.addEventListener("beforeunload",()=>{c()})})();